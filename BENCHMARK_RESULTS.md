# 📊 第四周 压测结果

## 测试环境

| 配置项 | 值 |
|--------|-----|
| 模型 | Qwen2.5-7B-Instruct |
| GPU | NVIDIA A10 (24GB) |
| 推理框架 | vLLM |
| 并发数 | 1 / 5 / 10 / 20 |

---

## 压测命令

```bash
# 单并发测试
python3 scripts/benchmark.py --concurrency 1 --requests 5

# 5并发测试
python3 scripts/benchmark.py --concurrency 5 --requests 50

# 10并发测试
python3 scripts/benchmark.py --concurrency 10 --requests 100

# 20并发测试
python3 scripts/benchmark.py --concurrency 20 --requests 200
```

---

## 测试结果汇总

### 1. 单并发 (c1_r1)

| 指标 | 值 |
|------|-----|
| 总请求数 | 1 |
| 成功请求 | 1 |
| 失败请求 | 0 |
| 总耗时 | 2.87s |
| QPS | 0.35 |

**延迟 (ms):**
- P50: 2874.6
- P95: 2874.6  
- P99: 2874.6
- 平均: 2874.6

**首 token 延迟 (TTFT):**
- P50: 183.2ms

**吞吐量:**
- 平均: 30.5 tokens/s

---

### 2. 单并发 5请求 (c1_r5)

| 指标 | 值 |
|------|-----|
| 总请求数 | 5 |
| 成功请求 | 5 |
| 失败请求 | 0 |
| 总耗时 | 36.35s |
| QPS | 0.14 |

**延迟 (ms):**
- P50: 8423.2
- P95: 8438.4
- P99: 8438.4
- 平均: 7270.0

**首 token 延迟 (TTFT):**
- P50: 42.2ms

**吞吐量:**
- 平均: 30.3 tokens/s

---

### 3. 5并发 (c5_r50)

| 指标 | 值 |
|------|-----|
| 总请求数 | 50 |
| 成功请求 | 50 |
| 失败请求 | 0 |
| 总耗时 | 77.62s |
| QPS | 0.64 |

**延迟 (ms):**
- P50: 8787.6
- P95: 8806.6
- P99: 8808.9
- 平均: 7500.7

**首 token 延迟 (TTFT):**
- P50: 101.6ms

**吞吐量:**
- 平均: 29.1 tokens/s

---

### 4. 10并发 (c10_r100)

| 指标 | 值 |
|------|-----|
| 总请求数 | 100 |
| 成功请求 | 100 |
| 失败请求 | 0 |
| 总耗时 | 82.16s |
| QPS | 1.22 |

**延迟 (ms):**
- P50: 9148.8
- P95: 9157.9
- P99: 9159.1
- 平均: 7795.0

**首 token 延迟 (TTFT):**
- P50: 105.4ms

**吞吐量:**
- 平均: 28.0 tokens/s

---

### 5. 20并发 (c20_r200)

| 指标 | 值 |
|------|-----|
| 总请求数 | 200 |
| 成功请求 | 200 |
| 失败请求 | 0 |
| 总耗时 | 85.33s |
| QPS | 2.34 |

**延迟 (ms):**
- P50: 9490.5
- P95: 9531.0
- P99: 9535.1
- 平均: 8118.7

**首 token 延迟 (TTFT):**
- P50: 109.3ms

**吞吐量:**
- 平均: 26.9 tokens/s

---

## 性能分析

### 关键发现

| 并发数 | QPS | 平均延迟(ms) | 吞吐量(tokens/s) | TTFT(ms) |
|--------|-----|--------------|-------------------|----------|
| 1 | 0.35 | 2874.6 | 30.5 | 183.2 |
| 1 (×5) | 0.14 | 7270.0 | 30.3 | 75.7 |
| 5 | 0.64 | 7500.7 | 29.1 | 101.6 |
| 10 | 1.22 | 7795.0 | 28.0 | 105.4 |
| 20 | 2.34 | 8118.7 | 26.9 | 109.3 |

### 结论

1. **吞吐量稳定**: 吞吐量稳定在 26-30 tokens/s，随着并发增加略有下降
2. **QPS 提升**: 并发从1增加到20，QPS从0.35提升到2.34
3. **延迟增加**: P50延迟从2.8s增加到9.5s，这是正常的排队等待
4. **TTFT 优化**: 首token延迟在并发情况下反而更短（得益于batching优化）

---

## 压测脚本

```python
# scripts/benchmark.py
import argparse
import time
import requests
import statistics

def benchmark(url, model, concurrency, total_requests):
    # 压测逻辑...
```

---

*测试时间: 2024年*
